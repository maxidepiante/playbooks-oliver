---
- name: ğŸ› ï¸ Mantenimiento Servidor FTP Windows 2016 - Oliver Backups
  hosts: oliftp-windows
  gather_facts: no

  tasks:
    - name: ğŸ“Š 1. INFORMACIÃ“N DEL SISTEMA
      win_command: systeminfo
      register: system_info

    - name: ğŸ“‹ Mostrar informaciÃ³n bÃ¡sica
      debug:
        msg: |
          ğŸ–¥ï¸  Servidor FTP: {{ inventory_hostname }}
          ğŸ”§ Sistema: Windows Server 2016 Standard  
          ğŸŒ IP: 192.168.0.36
          ğŸ¯ PropÃ³sito: Repositorio backups Cobian
          ğŸ“… Fecha: {{ ansible_date_time.date }}

    - name: ğŸ’¿ 2. ANÃLISIS DE DISCOS
      win_shell: |
        Write-Output "=== ANÃLISIS DE DISCOS ==="
        Get-PSDrive -PSProvider FileSystem | 
        Select-Object Name,
          @{Name="UsedGB";Expression={[math]::Round($_.Used/1GB,2)}},
          @{Name="FreeGB";Expression={[math]::Round($_.Free/1GB,2)}},
          @{Name="TotalGB";Expression={[math]::Round(($_.Used + $_.Free)/1GB,2)}}
      register: disk_analysis

    - name: ğŸ“‹ Mostrar estado discos
      debug:
        msg: "{{ disk_analysis.stdout }}"

    - name: ğŸ” 3. BUSCAR DIRECTORIOS DE BACKUP
      win_shell: |
        Write-Output "=== BUSQUEDA DE DIRECTORIOS BACKUP ==="
        
        # Buscar en todos los discos
        $drives = Get-PSDrive -PSProvider FileSystem | Select-Object -ExpandProperty Root
        $backupPatterns = @("*backup*", "*cobian*", "*Backup*", "*Cobian*", "*bkp*", "*BKP*")
        $foundBackups = @()
        
        foreach ($drive in $drives) {
          if (Test-Path $drive) {
            foreach ($pattern in $backupPatterns) {
              $dirs = Get-ChildItem -Path $drive -Directory -Filter $pattern -ErrorAction SilentlyContinue
              if ($dirs) {
                $foundBackups += $dirs
              }
            }
          }
        }
        
        if ($foundBackups.Count -gt 0) {
          Write-Output "âœ… Directorios de backup encontrados:"
          foreach ($dir in $foundBackups) {
            Write-Output "   â€¢ $($dir.FullName)"
          }
        } else {
          Write-Output "â„¹ï¸ No se encontraron directorios con nombres de backup"
          Write-Output "Directorios en raÃ­z de discos:"
          foreach ($drive in $drives) {
            if (Test-Path $drive) {
              $topDirs = Get-ChildItem -Path $drive -Directory -ErrorAction SilentlyContinue | 
                        Select-Object -First 3 Name
              if ($topDirs) {
                Write-Output "   $drive : $($topDirs.Name -join ', ')"
              }
            }
          }
        }
      register: backup_search
      changed_when: false

    - name: ğŸ“‹ Mostrar resultados bÃºsqueda
      debug:
        msg: "{{ backup_search.stdout }}"

    - name: ğŸ§¹ 4. LIMPIEZA DE ARCHIVOS TEMPORALES
      win_shell: |
        Write-Output "=== LIMPIEZA DE ARCHIVOS TEMPORALES ==="
        
        $tempPaths = @(
          "C:\Windows\Temp",
          "C:\Temp", 
          "$env:TEMP"
        )
        
        $totalDeleted = 0
        $totalFreedMB = 0
        
        foreach ($path in $tempPaths) {
          if (Test-Path $path) {
            $oldFiles = Get-ChildItem -Path $path -Recurse -File -ErrorAction SilentlyContinue | 
                      Where-Object { $_.LastWriteTime -lt (Get-Date).AddDays(-{{ temp_cleanup_days }}) }
            
            if ($oldFiles.Count -gt 0) {
              $sizeMB = [math]::Round(($oldFiles | Measure-Object -Property Length -Sum).Sum / 1MB, 2)
              Write-Output "Limpiando $($oldFiles.Count) archivos de $path ($sizeMB MB)..."
              $oldFiles | Remove-Item -Force -ErrorAction SilentlyContinue
              $totalDeleted += $oldFiles.Count
              $totalFreedMB += $sizeMB
            }
          }
        }
        
        Write-Output "âœ… Total: $totalDeleted archivos limpiados ($totalFreedMB MB liberados)"
      register: temp_cleanup
      changed_when: "temp_cleanup.stdout is search('archivos limpiados')"

    - name: ğŸ“‹ Mostrar resultado limpieza
      debug:
        msg: "{{ temp_cleanup.stdout }}"

    - name: ğŸ”§ 5. VERIFICACIÃ“N DE SERVICIOS CRÃTICOS
      win_shell: |
        Write-Output "=== VERIFICACIÃ“N DE SERVICIOS ==="
        
        # Servicios esenciales de Windows
        $services = @(
          @{Name="Spooler"; Desc="Servicio de impresiÃ³n"},
          @{Name="EventLog"; Desc="Registro de eventos"},
          @{Name="LanmanServer"; Desc="Servidor SMB"},
          @{Name="LanmanWorkstation"; Desc="Cliente SMB"},
          @{Name="Dhcp"; Desc="Cliente DHCP"},
          @{Name="Dnscache"; Desc="Cliente DNS"}
        )
        
        foreach ($svc in $services) {
          $status = Get-Service -Name $svc.Name -ErrorAction SilentlyContinue
          if ($status) {
            $icon = if ($status.Status -eq "Running") { "âœ…" } else { "âš ï¸" }
            Write-Output "$icon $($svc.Name) : $($status.Status)"
          }
        }
      register: service_check
      changed_when: false

    - name: ğŸ“‹ Mostrar estado servicios
      debug:
        msg: "{{ service_check.stdout }}"

    - name: ğŸ“ 6. GENERAR REPORTE LOCAL
      win_shell: |
        $dateStr = Get-Date -Format "yyyy-MM-dd"
        $reportPath = "C:\Temp\reporte-ftp-$dateStr.txt"
        
        # InformaciÃ³n bÃ¡sica
        $computerName = $env:COMPUTERNAME
        $disks = Get-PSDrive -PSProvider FileSystem | 
                Select-Object Name, 
                  @{Name="FreeGB";Expression={[math]::Round($_.Free/1GB,2)}},
                  @{Name="UsedGB";Expression={[math]::Round($_.Used/1GB,2)}}
        
        # Generar reporte
        @"
=== REPORTE MANTENIMIENTO FTP SERVER ===
Fecha: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
Servidor: $computerName
IP: 192.168.0.36
Sistema: Windows Server 2016 Standard

=== ESTADO DEL SISTEMA ===
Discos disponibles:
$($disks | Format-Table | Out-String)

=== MANTENIMIENTO EJECUTADO ===
- AnÃ¡lisis de espacio en discos
- BÃºsqueda de directorios de backup
- Limpieza de archivos temporales (>{{ temp_cleanup_days }} dÃ­as)
- VerificaciÃ³n de servicios crÃ­ticos

=== RECOMENDACIONES ===
1. Monitorear espacio libre regularmente
2. Verificar backups automÃ¡ticos de Cobian
3. Revisar logs del sistema periÃ³dicamente

Reporte generado automÃ¡ticamente por Ansible Semaphore
"@ | Out-File -FilePath $reportPath -Encoding UTF8
        
        Write-Output "ğŸ“„ Reporte generado en: $reportPath"
      register: report_generation
      changed_when: false

    - name: ğŸ“‹ Mostrar ubicaciÃ³n reporte
      debug:
        msg: |
          ğŸ“„ Reporte FTP generado en servidor
          ğŸ“ Ruta: C:\Temp\reporte-ftp-*.txt
          {{ report_generation.stdout_lines[-1] }}

    - name: âœ… 7. FINALIZACIÃ“N
      debug:
        msg: |
          âœ… MANTENIMIENTO FTP SERVER COMPLETADO
          
          Servidor: {{ inventory_hostname }}
          IP: 192.168.0.36
          
          Tareas ejecutadas:
          â€¢ âœ… VerificaciÃ³n del sistema
          â€¢ âœ… AnÃ¡lisis de espacio en discos  
          â€¢ âœ… BÃºsqueda de directorios backup
          â€¢ âœ… Limpieza de archivos temporales
          â€¢ âœ… VerificaciÃ³n de servicios
          â€¢ âœ… GeneraciÃ³n de reporte local
          
          Estado: SISTEMA OPERATIVO
          PrÃ³xima ejecuciÃ³n recomendada: Semanal

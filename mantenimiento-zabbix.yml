---
- name: ğŸ› ï¸ Mantenimiento AutomÃ¡tico - Servidor Zabbix
  hosts: zabbix_servers
  gather_facts: yes
  become: yes

  tasks:
    - name: ğŸ“¦ Actualizar sistema (Rocky Linux)
      yum:
        name: "*"
        state: latest
      when: ansible_distribution == "Rocky"

    - name: ğŸ§¹ Limpiar cache de paquetes
      shell: yum clean all
      when: ansible_distribution == "Rocky"

    - name: ğŸ“Š Verificar espacio en disco
      shell: df -h
      register: disk_space

    - name: ğŸ“‹ Mostrar espacio en disco
      debug:
        var: disk_space.stdout

    - name: ğŸ—‘ï¸ Limpiar logs antiguos
      find:
        paths: /var/log
        patterns: "*.log.*"
        age: "7d"
        file_type: file
      register: old_logs

    - name: ğŸ—‘ï¸ Eliminar logs antiguos
      file:
        path: "{{ item.path }}"
        state: absent
      with_items: "{{ old_logs.files }}"
      when: old_logs.matched > 0

    - name: ğŸ” Verificar servicios Zabbix
      systemd:
        name: "{{ item }}"
        state: started
      with_items:
        - zabbix-server
        - zabbix-agent
        - httpd
        - mariadb
      ignore_errors: yes

    - name: ğŸ“ˆ Verificar recursos del sistema
      shell: |
        echo "ğŸ’¾ Memoria: $(free -h | grep Mem | awk '{print $3 \"/\" $2}')"
        echo "ğŸ’¿ Disco: $(df -h / | tail -1 | awk '{print $3 \"/\" $2 \" libre: \" $4}')"
        echo "ğŸ”§ Load: $(uptime | awk -F'load average:' '{print $2}')"
      register: recursos

    - name: ğŸ“‹ Mostrar recursos
      debug:
        var: recursos.stdout_lines

    - name: âœ… Reporte de finalizaciÃ³n
      debug:
        msg: "âœ… Mantenimiento completado en {{ ansible_hostname }} - {{ ansible_date_time.iso8601 }}"

---
- name: üõ†Ô∏è Mantenimiento Autom√°tico - Windows Server 2019
  hosts: windows-server
  gather_facts: no

  tasks:
    - name: üîç PRUEBA - Comando simple de test
      win_shell: echo "‚úÖ Conexi√≥n SSH funcionando"
      register: test_cmd

    - name: üìã Mostrar resultado test
      debug:
        msg: "{{ test_cmd.stdout }}"

    - name: üìä Verificar informaci√≥n del sistema
      win_shell: systeminfo
      register: system_info_full

    - name: üìã Mostrar informaci√≥n completa del sistema
      debug:
        msg: "{{ system_info_full.stdout }}"

    - name: üßπ Limpiar archivos temporales del sistema
      win_shell: |
        Write-Output "Limpiando archivos temporales del sistema..."
        Get-ChildItem "C:\Windows\Temp\*" -ErrorAction SilentlyContinue | Remove-Item -Force -Recurse -ErrorAction SilentlyContinue
        Get-ChildItem "C:\Temp\*" -ErrorAction SilentlyContinue | Remove-Item -Force -Recurse -ErrorAction SilentlyContinue
        Write-Output "Limpieza de sistema completada"
      register: cleanup_system

    - name: üìã Mostrar resultado limpieza sistema
      debug:
        msg: "{{ cleanup_system.stdout }}"

    - name: üßπ Limpiar archivos temporales de usuario
      win_shell: |
        Write-Output "Limpiando archivos temporales de usuarios..."
        Remove-Item -Path "C:\Users\*\AppData\Local\Temp\*" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "C:\Users\*\AppData\Local\Microsoft\Windows\INetCache\*" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "C:\Users\*\AppData\Local\Microsoft\Windows\Temporary Internet Files\*" -Recurse -Force -ErrorAction SilentlyContinue
        Write-Output "Limpieza de usuarios completada"
      register: cleanup_users

    - name: üìã Mostrar resultado limpieza usuarios
      debug:
        msg: "{{ cleanup_users.stdout }}"

    - name: üõ°Ô∏è Buscar e instalar updates de Windows
      win_shell: |
        Write-Output "Buscando actualizaciones de Windows..."
        try {
          # Instalar m√≥dulo PSWindowsUpdate si no est√° presente
          if (!(Get-Module -ListAvailable -Name PSWindowsUpdate)) {
            Install-Module -Name PSWindowsUpdate -Force -Confirm:$false
          }
          Import-Module PSWindowsUpdate
          
          # Buscar e instalar updates cr√≠ticos y de seguridad
          $updates = Get-WUList -Category "Critical","Security"
          if ($updates) {
            Write-Output "Encontradas $($updates.Count) actualizaciones cr√≠ticas/seguridad"
            Install-WindowsUpdate -AcceptAll -AutoReboot:$false -Confirm:$false
            Write-Output "Actualizaciones instaladas correctamente"
          } else {
            Write-Output "No se encontraron actualizaciones cr√≠ticas pendientes"
          }
        } catch {
          Write-Output "Error en actualizaciones: $($_.Exception.Message)"
          Write-Output "Verificando con m√©todo alternativo..."
          # M√©todo alternativo sin m√≥dulo externo
          $session = New-Object -ComObject Microsoft.Update.Session
          $searcher = $session.CreateUpdateSearcher()
          $result = $searcher.Search("IsInstalled=0 and Type='Software'")
          Write-Output "Updates pendientes: $($result.Updates.Count)"
        }
      register: windows_updates

    - name: üìã Mostrar resultado de actualizaciones
      debug:
        msg: "{{ windows_updates.stdout }}"

    - name: üîç Verificar integridad de sistema de archivos
      win_shell: |
        Write-Output "Verificando integridad del sistema de archivos..."
        sfc /verifyonly
        if ($LASTEXITCODE -eq 0) {
          Write-Output "‚úÖ SFC: No se encontraron problemas de integridad"
        } else {
          Write-Output "‚ö†Ô∏è SFC: Se detectaron problemas. Ejecutar 'sfc /scannow' manualmente"
        }
      register: sfc_check

    - name: üìã Mostrar resultado SFC
      debug:
        msg: "{{ sfc_check.stdout }}"

    - name: üìà Verificar rendimiento del sistema
      win_shell: |
        Write-Output "=== MONITOREO DE RENDIMIENTO ==="
        
        # Memoria disponible
        $memory = Get-Counter "\Memory\Available MBytes" | Select-Object -ExpandProperty CounterSamples | Select-Object CookedValue
        Write-Output "Memoria disponible: $([math]::Round($memory.CookedValue)) MB"
        
        # Uso de CPU
        $cpu = Get-Counter "\Processor(_Total)\% Processor Time" | Select-Object -ExpandProperty CounterSamples | Select-Object CookedValue
        Write-Output "Uso de CPU: $([math]::Round($cpu.CookedValue, 2)) %"
        
        # Espacio en disco
        $disk = Get-PSDrive C | Select-Object Used, Free, @{Name="UsedGB";Expression={[math]::Round($_.Used/1GB,2)}}, @{Name="FreeGB";Expression={[math]::Round($_.Free/1GB,2)}}
        Write-Output "Disco C - Usado: $($disk.UsedGB) GB, Libre: $($disk.FreeGB) GB"
        
        # Procesos m√°s consumidores
        Write-Output "`nTop 5 procesos por uso de memoria:"
        Get-Process | Sort-Object WS -Descending | Select-Object -First 5 Name, CPU, WS, PM | Format-Table -AutoSize
      register: performance_check

    - name: üìã Mostrar resultado rendimiento
      debug:
        msg: "{{ performance_check.stdout }}"

    - name: üìä Verificar servicios cr√≠ticos
      win_shell: |
        Write-Output "=== ESTADO DE SERVICIOS CR√çTICOS ==="
        $services = @("Spooler", "EventLog", "LanmanServer", "LanmanWorkstation", "Dhcp", "Dnscache")
        foreach ($service in $services) {
          $status = Get-Service -Name $service -ErrorAction SilentlyContinue
          if ($status) {
            Write-Output "$service : $($status.Status)"
          } else {
            Write-Output "$service : No encontrado"
          }
        }
      register: services_check

    - name: üìã Mostrar estado de servicios
      debug:
        msg: "{{ services_check.stdout }}"

    - name: üóëÔ∏è Limpiar logs antiguos de Event Viewer
      win_shell: |
        Write-Output "Limpiando logs antiguos de Event Viewer..."
        $logs = @("Application", "System", "Security")
        foreach ($log in $logs) {
          try {
            wevtutil cl $log
            Write-Output "Log limpiado: $log"
          } catch {
            Write-Output "Error limpiando log $log : $($_.Exception.Message)"
          }
        }
        Write-Output "Limpieza de logs completada"
      register: event_cleanup

    - name: üìã Mostrar resultado limpieza logs
      debug:
        msg: "{{ event_cleanup.stdout }}"

    - name: üìù Generar reporte de mantenimiento
      win_shell: |
        $fecha = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        $computer = $env:COMPUTERNAME
        $reporte = "REPORTE DE MANTENIMIENTO - $fecha`nEquipo: $computer`nTareas completadas:`n‚úÖ Limpieza archivos temporales del sistema`n‚úÖ Limpieza archivos temporales de usuarios`n‚úÖ Verificaci√≥n de actualizaciones de Windows`n‚úÖ Verificaci√≥n integridad SFC`n‚úÖ Monitoreo de rendimiento`n‚úÖ Verificaci√≥n de servicios cr√≠ticos`n‚úÖ Limpieza de logs de Event Viewer`n`nEjecutado desde Ansible Semaphore"
        $reporte | Out-File "C:\Temp\reporte-mantenimiento.txt" -Encoding UTF8
        Write-Output "Reporte generado en C:\Temp\reporte-mantenimiento.txt"
      register: reporte

    - name: üìã Mostrar ubicaci√≥n del reporte
      debug:
        msg: "{{ reporte.stdout }}"

    - name: ‚úÖ FINALIZADO
      debug:
        msg: "‚úÖ Mantenimiento Windows completado en {{ inventory_hostname }} - Todas las tareas ejecutadas"

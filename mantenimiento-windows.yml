---
- name: ğŸ› ï¸ Mantenimiento AutomÃ¡tico - Windows Server 2019
  hosts: windows-server
  gather_facts: no  # Windows requiere setup especÃ­fico para facts

  tasks:
    - name: ğŸ“Š Verificar informaciÃ³n del sistema
      win_shell: systeminfo | findstr /C:"OS Name" /C:"OS Version" /C:"Total Physical Memory"
      register: system_info

    - name: ğŸ“‹ Mostrar informaciÃ³n del sistema
      debug:
        msg: "{{ system_info.stdout_lines }}"

    - name: ğŸ§¹ Limpiar archivos temporales
      win_shell: |
        Remove-Item -Path "C:\Windows\Temp\*" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "C:\Temp\*" -Recurse -Force -ErrorAction SilentlyContinue
      register: cleanup

    - name: ğŸ“Š Verificar espacio en disco
      win_shell: |
        Get-PSDrive C | Select-Object Name,Used,Free,@{Name="FreeGB";Expression={[math]::Round($_.Free/1GB,2)}},@{Name="UsedGB";Expression={[math]::Round($_.Used/1GB,2)}}
      register: disk_space

    - name: ğŸ“‹ Mostrar espacio en disco
      debug:
        msg: "Espacio en disco C: {{ disk_space.stdout }}"

    - name: ğŸ” Verificar servicios crÃ­ticos
      win_shell: |
        Get-Service -Name "Spooler","EventLog","LanmanServer" | Select-Object Name,Status
      register: services_status

    - name: ğŸ“‹ Mostrar estado de servicios
      debug:
        msg: "Servicios: {{ services_status.stdout }}"

    - name: ğŸ—‘ï¸ Limpiar logs antiguos de Event Viewer
      win_shell: |
        wevtutil el | ForEach-Object {
          try {
            wevtutil cl "$_"
            Write-Output "Limpiado: $_"
          } catch {
            Write-Output "Error limpiando: $_"
          }
        }
      register: event_cleanup

    - name: ğŸ›¡ï¸ Verificar updates de seguridad
      win_shell: |
        Get-HotFix | Sort-Object InstalledOn -Descending | Select-Object -First 5
      register: hotfixes

    - name: ğŸ“‹ Mostrar Ãºltimos updates
      debug:
        msg: "Ãšltimos hotfixes: {{ hotfixes.stdout }}"

    - name: âœ… FINALIZADO
      debug:
        msg: "âœ… Mantenimiento Windows completado en {{ inventory_hostname }}"

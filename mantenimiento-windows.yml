---
- name: üõ†Ô∏è Mantenimiento Autom√°tico - Windows Server 2019
  hosts: windows-server
  gather_facts: no

  tasks:
    - name: üîç PRUEBA - Comando simple de test
      win_shell: echo "‚úÖ Conexi√≥n SSH funcionando"
      register: test_cmd

    - name: üßπ Limpiar archivos temporales del sistema
      win_shell: |
        Write-Output "Limpiando archivos temporales del sistema..."
        Get-ChildItem "C:\Windows\Temp\*" -ErrorAction SilentlyContinue | Remove-Item -Force -Recurse -ErrorAction SilentlyContinue
        Get-ChildItem "C:\Temp\*" -ErrorAction SilentlyContinue | Remove-Item -Force -Recurse -ErrorAction SilentlyContinue
        Write-Output "Limpieza de sistema completada"
      register: cleanup_system

    - name: üßπ Limpiar archivos temporales de usuario
      win_shell: |
        Write-Output "Limpiando archivos temporales de usuarios..."
        Remove-Item -Path "C:\Users\*\AppData\Local\Temp\*" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "C:\Users\*\AppData\Local\Microsoft\Windows\INetCache\*" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "C:\Users\*\AppData\Local\Microsoft\Windows\Temporary Internet Files\*" -Recurse -Force -ErrorAction SilentlyContinue
        Write-Output "Limpieza de usuarios completada"
      register: cleanup_users

    - name: üõ°Ô∏è INSTALAR updates de Windows con m√©todo mejorado
      win_shell: |
        Write-Output "=== INSTALACI√ìN MEJORADA DE UPDATES ==="
        
        # M√©todo 1: Intentar con Windows Update nativo
        Write-Output "M√©todo 1: Windows Update nativo..."
        $Session = New-Object -ComObject "Microsoft.Update.Session"
        $Searcher = $Session.CreateUpdateSearcher()
        
        $SearchResult = $Searcher.Search("IsInstalled=0 and Type='Software'")
        
        if ($SearchResult.Updates.Count -eq 0) {
            Write-Output "‚úÖ No hay updates pendientes"
            exit 0
        }
        
        Write-Output "Encontrados $($SearchResult.Updates.Count) updates pendientes:"
        foreach ($Update in $SearchResult.Updates) {
            Write-Output " - $($Update.Title)"
        }
        
        # Intentar instalar con m√©todo nativo
        $Installer = $Session.CreateUpdateInstaller()
        $Installer.Updates = $SearchResult.Updates
        $InstallationResult = $Installer.Install()
        
        if ($InstallationResult.ResultCode -eq 2) {
            Write-Output "‚úÖ Updates instalados correctamente con m√©todo nativo"
            $exitCode = 0
        } else {
            Write-Output "‚ö†Ô∏è M√©todo nativo fall√≥. C√≥digo: $($InstallationResult.ResultCode)"
            Write-Output "Intentando m√©todo alternativo..."
            
            # M√©todo 2: Usar PowerShell cmdlets (m√°s tolerante)
            try {
                # Para updates de Defender, usar m√©todo espec√≠fico
                $defenderUpdate = $SearchResult.Updates | Where-Object { $_.Title -like "*Defender*" -or $_.Title -like "*KB2267602*" }
                if ($defenderUpdate) {
                    Write-Output "Detectada actualizaci√≥n de Defender, intentando m√©todo espec√≠fico..."
                    
                    # M√©todo para Defender - actualizar definiciones
                    & "C:\Program Files\Windows Defender\MpCmdRun.exe" -SignatureUpdate -Force
                    if ($LASTEXITCODE -eq 0) {
                        Write-Output "‚úÖ Definiciones de Defender actualizadas correctamente"
                        $exitCode = 0
                    } else {
                        Write-Output "‚ö†Ô∏è No se pudieron actualizar definiciones de Defender"
                        $exitCode = 1
                    }
                } else {
                    Write-Output "‚ÑπÔ∏è No es update de Defender, continuando..."
                    $exitCode = 1
                }
            } catch {
                Write-Output "‚ùå Error en m√©todo alternativo: $($_.Exception.Message)"
                $exitCode = 1
            }
        }
        
        # Verificar estado final
        if ($exitCode -eq 0) {
            Write-Output "`nüéØ RESULTADO: Updates instalados/manejados correctamente"
        } else {
            Write-Output "`n‚ö†Ô∏è RESULTADO: Algunos updates pueden requerir intervenci√≥n manual"
            Write-Output "üí° Los updates de Defender a veces fallan si el servicio est√° ocupado"
            Write-Output "üí° Se reintentar√°n autom√°ticamente en la pr√≥xima ejecuci√≥n"
        }
      register: windows_updates
      ignore_errors: yes

    - name: üìã Mostrar resultado de actualizaciones
      debug:
        msg: "{{ windows_updates.stdout }}"

    - name: üîç Verificar integridad de sistema de archivos
      win_shell: |
        Write-Output "Verificando integridad del sistema de archivos..."
        sfc /verifyonly
        if ($LASTEXITCODE -eq 0) {
          Write-Output "‚úÖ SFC: No se encontraron problemas de integridad"
        } else {
          Write-Output "‚ö†Ô∏è SFC: Se detectaron problemas. Ejecutar 'sfc /scannow' manualmente"
        }
      register: sfc_check

    - name: üìà Verificar rendimiento del sistema
      win_shell: |
        Write-Output "=== MONITOREO DE RENDIMIENTO ==="
        
        # Espacio en disco
        $disk = Get-PSDrive C | Select-Object Used, Free, @{Name="UsedGB";Expression={[math]::Round($_.Used/1GB,2)}}, @{Name="FreeGB";Expression={[math]::Round($_.Free/1GB,2)}}
        Write-Output "Disco C - Usado: $($disk.UsedGB) GB, Libre: $($disk.FreeGB) GB"
        
        # Memoria
        $memory = Get-WmiObject Win32_OperatingSystem
        $freeMemory = [math]::Round($memory.FreePhysicalMemory / 1MB, 2)
        $totalMemory = [math]::Round($memory.TotalVisibleMemorySize / 1MB, 2)
        Write-Output "Memoria - Libre: $freeMemory GB, Total: $totalMemory GB"
        
        # Versi√≥n actual de Defender
        try {
            $defenderVersion = & "C:\Program Files\Windows Defender\MpCmdRun.exe" -GetFiles
            Write-Output "Defender: Ejecut√°ndose correctamente"
        } catch {
            Write-Output "Defender: Informaci√≥n no disponible"
        }
      register: performance_check

    - name: üìä Verificar servicios cr√≠ticos
      win_shell: |
        Write-Output "=== ESTADO DE SERVICIOS CR√çTICOS ==="
        $services = @("Spooler", "EventLog", "LanmanServer", "LanmanWorkstation", "Dhcp", "Dnscache", "WinDefend")
        foreach ($service in $services) {
          $status = Get-Service -Name $service -ErrorAction SilentlyContinue
          if ($status) {
            Write-Output "$service : $($status.Status)"
          } else {
            Write-Output "$service : No encontrado"
          }
        }
      register: services_check

    - name: üóëÔ∏è Limpiar logs antiguos de Event Viewer
      win_shell: |
        Write-Output "Limpiando logs antiguos de Event Viewer..."
        $logs = @("Application", "System", "Security")
        foreach ($log in $logs) {
          try {
            wevtutil cl $log
            Write-Output "Log limpiado: $log"
          } catch {
            Write-Output "Error limpiando log $log : $($_.Exception.Message)"
          }
        }
        Write-Output "Limpieza de logs completada"
      register: event_cleanup

    - name: üìù Generar reporte de mantenimiento
      win_shell: |
        $fecha = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        $computer = $env:COMPUTERNAME
        
        $reporte = "REPORTE DE MANTENIMIENTO - $fecha`nEquipo: $computer`n`nTareas completadas:`n‚úÖ Limpieza archivos temporales`n‚úÖ Gesti√≥n de updates de Windows`n‚úÖ Verificaci√≥n integridad SFC`n‚úÖ Monitoreo de rendimiento`n‚úÖ Verificaci√≥n de servicios cr√≠ticos`n‚úÖ Limpieza de logs de Event Viewer`n`nEjecutado desde Ansible Semaphore`n`nNota: Los updates de Defender se reintentan autom√°ticamente"
        $reporte | Out-File "C:\Temp\reporte-mantenimiento.txt" -Encoding UTF8
        Write-Output "Reporte generado en C:\Temp\reporte-mantenimiento.txt"
      register: reporte

    - name: ‚úÖ FINALIZADO
      debug:
        msg: "‚úÖ Mantenimiento Windows completado en {{ inventory_hostname }}"

---
- name: ðŸ› ï¸ Mantenimiento Avanzado - TrueNAS Scale Backup Server
  hosts: truenas_servers
  gather_facts: yes
  become: yes

  tasks:
    - name: ðŸ“Š 1. INFORMACIÃ“N BÃSICA DEL SISTEMA
      debug:
        msg: |
          ðŸ–¥ï¸  Servidor: {{ ansible_hostname }}
          ðŸ”§ TrueNAS Scale 
          ðŸŒ IP: 192.168.0.144
          ðŸŽ¯ PropÃ³sito: Repositorio backups VMs y BD Oliver
          ðŸ“… Fecha ejecuciÃ³n: {{ ansible_date_time.date }}

    - name: â° 2. VERIFICAR UPTIME Y CARGA DEL SISTEMA
      shell: |
        echo "=== UPTIME Y CARGA ==="
        uptime
        echo "---"
        echo "=== PROCESOS ACTIVOS ==="
        ps aux --sort=-%cpu | head -5
      register: system_load
      changed_when: false

    - name: ðŸ“‹ Mostrar carga del sistema
      debug:
        msg: "{{ system_load.stdout }}"

    - name: ðŸ’¾ 3. MONITOREO AVANZADO ZFS
      block:
        - name: 3.1 - Estado pools ZFS
          shell: zpool list -o name,size,alloc,free,health,dedup,ratio
          register: zpool_list

        - name: 3.2 - Estado detallado pools
          shell: zpool status
          register: zpool_status

        - name: 3.3 - Ãšltimo scrub de cada pool
          shell: |
            echo "=== HISTORIAL SCRUB ==="
            for pool in $(zpool list -H -o name); do
              echo "Pool: $pool"
              zpool history $pool | grep -i scrub | tail -2 || echo "  No hay scrub registrado"
              echo ""
            done
          register: zpool_scrub
          changed_when: false

      rescue:
        - name: âš ï¸ Error en monitoreo ZFS
          debug:
            msg: "Error accediendo a ZFS - sistema puede estar ocupado"

    - name: ðŸ“‹ Mostrar estado ZFS
      debug:
        msg: |
          === POOLS ZFS ===
          {{ zpool_list.stdout }}
          
          === ESTADO DETALLADO ===  
          {{ zpool_status.stdout }}

    - name: ðŸ“Š 4. USO DE RECURSOS
      shell: |
        echo "=== MEMORIA ==="
        free -h
        echo "---"
        echo "=== CPU ==="
        top -bn1 | grep "Cpu(s)"
        echo "---"
        echo "=== TEMPERATURAS (si disponibles) ==="
        sensors 2>/dev/null | grep -E "(Core|Package|temp)" | head -5 || echo "Sensores no disponibles"
      register: system_resources
      changed_when: false

    - name: ðŸ“‹ Mostrar recursos del sistema
      debug:
        msg: "{{ system_resources.stdout }}"

    - name: ðŸ’¿ 5. ANÃLISIS DE ESPACIO EN DISCO
      shell: |
        echo "=== ESPACIO GENERAL ==="
        df -h
        echo "---"
        echo "=== ESPACIO POR DATASET (Top 10) ==="
        zfs list -t filesystem -o name,used,avail,refer,mountpoint -s used | head -11
        echo "---"
        echo "=== SNAPSHOTS POR DATASET ==="
        zfs list -t snapshot -o name,used,refer -s used | head -10
      register: disk_analysis
      changed_when: false

    - name: ðŸ“‹ Mostrar anÃ¡lisis de disco
      debug:
        msg: "{{ disk_analysis.stdout }}"

    - name: ðŸ§¹ 6. MANTENIMIENTO Y LIMPIEZA
      block:
        - name: 6.1 - Limpiar logs antiguos (14+ dÃ­as)
          shell: |
            echo "=== LIMPIEZA DE LOGS ==="
            find /var/log -name "*.log" -type f -mtime +14 -delete 2>/dev/null || true
            echo "Logs de +14 dÃ­as limpiados"
          changed_when: false

        - name: 6.2 - Limpiar archivos temporales del sistema
          shell: |
            echo "=== LIMPIEZA TEMPORALES ==="
            find /tmp -type f -mtime +7 -delete 2>/dev/null || true
            echo "Archivos temporales de +7 dÃ­as limpiados"
          changed_when: false

        - name: 6.3 - Verificar espacio en /boot (si existe)
          shell: |
            if [ -d /boot ]; then
              echo "=== ESPACIO EN /boot ==="
              df -h /boot
              echo "Kernels antiguos:"
              ls -la /boot/initrd.img-* 2>/dev/null | wc -l || echo "No hay kernels antiguos"
            else
              echo "No hay directorio /boot"
            fi
          changed_when: false

    - name: ðŸ”§ 7. VERIFICACIÃ“N DE SERVICIOS
      block:
        - name: 7.1 - Servicios crÃ­ticos TrueNAS
          systemd:
            name: "{{ item }}"
            state: started
          with_items:
            - sshd
            - middlewared
            - nginx
            - netdata
          ignore_errors: yes
          register: services_status

        - name: 7.2 - Servicios de almacenamiento
          systemd:
            name: "{{ item }}"
            state: started
          with_items:
            - smbd
            - nmbd
            - avahi-daemon
          ignore_errors: yes

      rescue:
        - name: âš ï¸ Algunos servicios no estÃ¡n corriendo
          debug:
            msg: "Algunos servicios no estÃ¡n corriendo - verificar manualmente"

    - name: ðŸ“‹ Mostrar estado de servicios
      debug:
        msg: |
          {{ services_status.results | selectattr('state', 'defined') | 
             map(attribute='item') | list | join(', ') }} servicios verificados

    - name: ðŸ›¡ï¸ 8. VERIFICACIÃ“N DE SEGURIDAD
      shell: |
        echo "=== VERIFICACIÃ“N SEGURIDAD ==="
        echo "Ãšltimos logins SSH exitosos:"
        last -n 5
        echo "---"
        echo "Intentos fallidos SSH (24h):"
        journalctl -u ssh --since "24 hours ago" | grep "Failed password" | tail -3 || echo "No hay intentos fallidos"
        echo "---"
        echo "Conexiones activas:"
        ss -tunap | grep ESTAB | head -5 || echo "No hay conexiones activas"
      register: security_check
      changed_when: false

    - name: ðŸ“‹ Mostrar verificaciÃ³n seguridad
      debug:
        msg: "{{ security_check.stdout }}"

    - name: ðŸ“ 9. GENERAR REPORTE RESUMEN
      shell: |
        DATE=$(date '+%Y-%m-%d_%H-%M-%S')
        REPORT="/tmp/reporte-truenas-$DATE.txt"
        
        echo "=== REPORTE MANTENIMIENTO TRUENAS ===" > $REPORT
        echo "Fecha: $(date '+%Y-%m-%d %H:%M:%S')" >> $REPORT
        echo "Host: $(hostname)" >> $REPORT
        echo "IP: 192.168.0.144" >> $REPORT
        echo "" >> $REPORT
        
        echo "=== RESUMEN ZFS ===" >> $REPORT
        zpool list >> $REPORT
        echo "" >> $REPORT
        
        echo "=== ESPACIO DISCO ===" >> $REPORT
        df -h >> $REPORT
        echo "" >> $REPORT
        
        echo "=== MEMORIA ===" >> $REPORT
        free -h >> $REPORT
        echo "" >> $REPORT
        
        echo "=== UPTIME ===" >> $REPORT
        uptime >> $REPORT
        echo "" >> $REPORT
        
        echo "=== ESTADO SERVICIOS ===" >> $REPORT
        systemctl is-active sshd middlewared nginx 2>/dev/null >> $REPORT
        
        echo "Reporte generado en: $REPORT"
        cat $REPORT | tail -20
      register: report_generation
      changed_when: false

    - name: ðŸ“‹ Mostrar ubicaciÃ³n reporte
      debug:
        msg: |
          ðŸ“„ Reporte generado en TrueNAS: /tmp/reporte-truenas-*.txt
          ðŸ“‹ Ãšltimas lÃ­neas del reporte:
          {{ report_generation.stdout_lines[-10:] | join('\n') }}

    - name: âœ… 10. FINALIZACIÃ“N
      debug:
        msg: |
          âœ… MANTENIMIENTO TRUENAS COMPLETADO
          
          Resumen:
          â€¢ Sistema: {{ ansible_hostname }}
          â€¢ Pools ZFS: {{ zpool_list.stdout_lines | length - 1 }} pools verificados
          â€¢ Estado: TODOS LOS CHECKS COMPLETADOS
          â€¢ Reporte: Generado en /tmp/reporte-truenas-*.txt
          
          ðŸ•’ PrÃ³xima ejecuciÃ³n recomendada: 7 dÃ­as

---
- name: ðŸ› ï¸ Mantenimiento AutomÃ¡tico - TrueNAS Scale Backup Server
  hosts: truenas_servers
  gather_facts: yes
  become: yes

  tasks:
    - name: ðŸ“Š Verificar informaciÃ³n del sistema
      debug:
        msg: |
          Servidor: {{ ansible_hostname }}
          TrueNAS Scale
          IP: 192.168.0.144
          PropÃ³sito: Repositorio backups VMs y BD Oliver

    - name: ðŸ“ˆ Verificar pools ZFS
      shell: zpool list -H -o name,size,alloc,free,health
      register: zpool_info

    - name: ðŸ“‹ Mostrar estado pools ZFS
      debug:
        msg: "{{ zpool_info.stdout_lines }}"

    - name: ðŸ” Verificar espacio del sistema
      shell: df -h
      register: disk_space

    - name: ðŸ“‹ Mostrar espacio en disco
      debug:
        var: disk_space.stdout

    - name: ðŸ§¹ Limpiar logs antiguos (7+ dÃ­as)
      shell: |
        find /var/log -name "*.log" -type f -mtime +7 -delete 2>/dev/null || true
        echo "Logs antiguos limpiados"
      changed_when: false

    - name: ðŸ”„ Verificar servicios crÃ­ticos
      systemd:
        name: "{{ item }}"
        state: started
      with_items:
        - sshd
        - middlewared
      ignore_errors: yes

    - name: âœ… FINALIZADO
      debug:
        msg: "âœ… Mantenimiento TrueNAS completado en {{ ansible_hostname }}"

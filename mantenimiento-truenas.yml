---
- name: ðŸ› ï¸ Mantenimiento Avanzado - TrueNAS Scale Backup Server
  hosts: truenas_servers
  gather_facts: yes
  become: yes

  vars:
    # Variables para control
    check_zfs_scrub: true
    generate_report: true

  tasks:
    - name: ðŸ“Š 1. INFORMACIÃ“N BÃSICA DEL SISTEMA
      debug:
        msg: |
          ðŸ–¥ï¸  Servidor: {{ ansible_hostname }}
          ðŸ”§ TrueNAS Scale 
          ðŸŒ IP: 192.168.0.144
          ðŸŽ¯ PropÃ³sito: Repositorio backups VMs y BD Oliver
          ðŸ“… Fecha ejecuciÃ³n: {{ ansible_date_time.date }}

    - name: â° 2. VERIFICAR UPTIME Y CARGA DEL SISTEMA
      shell: |
        echo "=== UPTIME Y CARGA ==="
        uptime
        echo "---"
        echo "=== PROCESOS ACTIVOS ==="
        ps aux --sort=-%cpu | head -5
      register: system_load
      changed_when: false

    - name: ðŸ“‹ Mostrar carga del sistema
      debug:
        msg: "{{ system_load.stdout }}"

    - name: ðŸ’¾ 3. MONITOREO ZFS BÃSICO
      block:
        - name: 3.1 - Estado pools ZFS (compatible)
          shell: zpool list -o name,size,alloc,free,health,dedup
          register: zpool_list

        - name: 3.2 - Estado detallado pools
          shell: zpool status
          register: zpool_status

      rescue:
        - name: âš ï¸ Error en monitoreo ZFS bÃ¡sico
          debug:
            msg: "Error accediendo a ZFS - usando comando alternativo"
          set_fact:
            zpool_list: "{{ {'stdout': 'InformaciÃ³n ZFS no disponible'}} }"
            zpool_status: "{{ {'stdout': 'Estado ZFS no disponible'}} }"

    - name: ðŸ“‹ Mostrar estado ZFS bÃ¡sico
      debug:
        msg: |
          === POOLS ZFS ===
          {{ zpool_list.stdout if zpool_list is defined else 'No disponible' }}
          
          === ESTADO DETALLADO ===  
          {{ zpool_status.stdout if zpool_status is defined else 'No disponible' }}

    - name: ðŸ“Š 4. USO DE RECURSOS DEL SISTEMA
      shell: |
        echo "=== MEMORIA ==="
        free -h
        echo "---"
        echo "=== CPU ==="
        top -bn1 | grep "Cpu(s)" || echo "InformaciÃ³n CPU no disponible"
        echo "---"
        echo "=== TEMPERATURAS (si disponibles) ==="
        sensors 2>/dev/null | grep -E "(Core|Package|temp)" | head -3 || echo "Sensores no disponibles"
      register: system_resources
      changed_when: false

    - name: ðŸ“‹ Mostrar recursos del sistema
      debug:
        msg: "{{ system_resources.stdout }}"

    - name: ðŸ’¿ 5. ANÃLISIS DE ESPACIO EN DISCO (compatible)
      shell: |
        echo "=== ESPACIO GENERAL ==="
        df -h
        echo "---"
        echo "=== DATASETS PRINCIPALES ==="
        zfs list -t filesystem -o name,used,avail,refer,mountpoint | grep -E "(boot-pool|datos)" || echo "No se encontraron datasets principales"
      register: disk_analysis
      changed_when: false

    - name: ðŸ“‹ Mostrar anÃ¡lisis de disco
      debug:
        msg: "{{ disk_analysis.stdout }}"

    - name: ðŸ§¹ 6. MANTENIMIENTO Y LIMPIEZA
      block:
        - name: 6.1 - Limpiar logs antiguos (14+ dÃ­as)
          shell: |
            echo "=== LIMPIEZA DE LOGS ==="
            find /var/log -name "*.log" -type f -mtime +14 -delete 2>/dev/null || true
            echo "Logs de +14 dÃ­as limpiados"
          changed_when: false

        - name: 6.2 - Limpiar archivos temporales del sistema
          shell: |
            echo "=== LIMPIEZA TEMPORALES ==="
            find /tmp -type f -mtime +7 -delete 2>/dev/null || true
            echo "Archivos temporales de +7 dÃ­as limpiados"
          changed_when: false

      rescue:
        - name: âš ï¸ Error en limpieza
          debug:
            msg: "Algunas tareas de limpieza fallaron - continuando..."

    - name: ðŸ”§ 7. VERIFICACIÃ“N DE SERVICIOS CRÃTICOS
      block:
        - name: 7.1 - Servicios esenciales
          systemd:
            name: "{{ item }}"
            state: started
          with_items:
            - sshd
            - middlewared
          ignore_errors: yes
          register: essential_services

        - name: 7.2 - Servicios opcionales
          systemd:
            name: "{{ item }}"
            state: started
          with_items:
            - nginx
            - netdata
          ignore_errors: yes

      rescue:
        - name: âš ï¸ Algunos servicios tienen problemas
          debug:
            msg: "Algunos servicios no estÃ¡n corriendo - verificar manualmente si es necesario"

    - name: ðŸ“‹ Mostrar resumen servicios
      debug:
        msg: |
          Servicios verificados:
          â€¢ sshd: {{ 'âœ…' if essential_services is defined else 'â“' }}
          â€¢ middlewared: {{ 'âœ…' if essential_services is defined else 'â“' }}

    - name: ðŸ›¡ï¸ 8. VERIFICACIÃ“N BÃSICA DE SEGURIDAD
      shell: |
        echo "=== VERIFICACIÃ“N SEGURIDAD ==="
        echo "Ãšltimos logins:"
        last -n 3 | head -5
        echo "---"
        echo "Uptime sistema:"
        uptime -p
      register: security_check
      changed_when: false

    - name: ðŸ“‹ Mostrar verificaciÃ³n seguridad
      debug:
        msg: "{{ security_check.stdout }}"

    - name: ðŸ“ 9. GENERAR REPORTE SIMPLE
      shell: |
        DATE=$(date '+%Y-%m-%d')
        REPORT="/tmp/reporte-truenas-$DATE.txt"
        
        echo "=== REPORTE TRUENAS ===" > $REPORT
        echo "Fecha: $(date '+%Y-%m-%d %H:%M:%S')" >> $REPORT
        echo "Host: $(hostname)" >> $REPORT
        echo "" >> $REPORT
        
        echo "=== RESUMEN ===" >> $REPORT
        uptime >> $REPORT
        echo "" >> $REPORT
        
        echo "=== ESPACIO ===" >> $REPORT
        df -h | grep -E "(Filesystem|boot-pool|datos)" >> $REPORT
        echo "" >> $REPORT
        
        echo "Reporte guardado en: $REPORT"
        echo "Ãšltimas 5 lÃ­neas:"
        tail -5 $REPORT
      register: report_generation
      changed_when: false

    - name: ðŸ“‹ Mostrar ubicaciÃ³n reporte
      debug:
        msg: |
          ðŸ“„ Reporte generado: /tmp/reporte-truenas-*.txt
          ðŸ“‹ Resumen:
          {{ report_generation.stdout_lines[-5:] | join('\n') }}

    - name: âœ… 10. FINALIZACIÃ“N
      debug:
        msg: |
          âœ… MANTENIMIENTO TRUENAS COMPLETADO
          
          Resumen ejecuciÃ³n:
          â€¢ Sistema: {{ ansible_hostname }}
          â€¢ Uptime: {{ system_load.stdout_lines[0] if system_load is defined else 'N/A' }}
          â€¢ Pools ZFS: Verificados
          â€¢ Limpieza: Logs y temporales
          â€¢ Servicios: CrÃ­ticos verificados
          â€¢ Reporte: Generado en /tmp/
          
          âœ… Estado: SISTEMA ESTABLE
